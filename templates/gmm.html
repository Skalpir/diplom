{% extends "layout.html" %}
{% block title %}–ê–Ω–∞–ª—ñ–∑ GMM{% endblock %}
{% block content %}

<h2>üß™ –ê–Ω–∞–ª—ñ–∑ GMM</h2>
<p>–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é: —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –º–æ–¥–µ–ª—å –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –Ω–∞—è–≤–Ω—É.</p>

<!-- –í–∏–±—ñ—Ä –¥—ñ—ó -->
<div class="mb-3">
  <label for="gmm-mode" class="form-label">–î—ñ—è</label>
  <select class="form-select" id="gmm-mode" onchange="toggleGMMMode()">
    <option value="new">–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤—É –º–æ–¥–µ–ª—å</option>
    <option value="existing">–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —ñ—Å–Ω—É—é—á—É –º–æ–¥–µ–ª—å</option>
  </select>
</div>

<!-- üîß –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ—ó –º–æ–¥–µ–ª—ñ -->
<div id="new-gmm-section">
  <form id="gmm-form" method="POST" action="/run_gmm" enctype="multipart/form-data">

    <!-- üéØ –†–æ–±–æ—Ç–∞ –∑ —à–∞–±–ª–æ–Ω–∞–º–∏ -->
    <div class="mb-3">
      <label for="template-select" class="form-label">üîñ –û–±—Ä–∞—Ç–∏ —à–∞–±–ª–æ–Ω</label>
      <select class="form-select" id="template-select">
        <option value="">-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —à–∞–±–ª–æ–Ω --</option>
        {% for template in templates %}
          <option value="{{ template }}">{{ template }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label for="template_name" class="form-label">–ù–∞–∑–≤–∞ –Ω–æ–≤–æ–≥–æ —à–∞–±–ª–æ–Ω—É</label>
      <input type="text" class="form-control" id="template_name" name="template_name" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: my_config">
    </div>

    <button type="button" class="btn btn-outline-primary mb-3" onclick="saveTemplate()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —à–∞–±–ª–æ–Ω</button>

    <!-- üßÆ –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤ -->
    <div class="mb-3">
      <label for="n_components" class="form-label">
        –ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="–ö—ñ–ª—å–∫—ñ—Å—Ç—å –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤ —É –º–æ–¥–µ–ª—ñ. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: 3‚Äì10 –¥–ª—è –∑–≤–∏—á–∞–π–Ω–∏—Ö –∑–∞–¥–∞—á –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü—ñ—ó.">‚ÑπÔ∏è</span>
      </label>
      <input type="number" class="form-control" id="n_components" name="n_components" value="3" min="1">
    </div>

    <div class="mb-3">
      <label for="max_iter" class="form-label">
        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —ñ—Ç–µ—Ä–∞—Ü—ñ–π
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —ñ—Ç–µ—Ä–∞—Ü—ñ–π, —è–∫—É –¥–æ–∑–≤–æ–ª–µ–Ω–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É. –ó–∞–∑–≤–∏—á–∞–π: 100‚Äì300.">‚ÑπÔ∏è</span>
      </label>
      <input type="number" class="form-control" id="max_iter" name="max_iter" value="100" min="1">
    </div>

    <div class="mb-3">
      <label for="tol" class="form-label">
        –î–æ–ø—É—Å–∫ –∑—É–ø–∏–Ω–∫–∏ tol
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="–ü–æ—Ä—ñ–≥ –∑—É–ø–∏–Ω–∫–∏ —ñ—Ç–µ—Ä–∞—Ü—ñ–π, —è–∫—â–æ –∑–º—ñ–Ω–∏ —Å—Ç–∞–ª–∏ –º–µ–Ω—à—ñ –∑–∞ —Ü–µ –∑–Ω–∞—á–µ–Ω–Ω—è. –ó–∞–∑–≤–∏—á–∞–π: 1e-3.">‚ÑπÔ∏è</span>
      </label>
      <input type="number" step="any" class="form-control" id="tol" name="tol" value="1e-3">
    </div>

    <div class="mb-3">
      <label for="reg_cov" class="form-label">
        –†–µ–≥—É–ª—è—Ä–∏–∑–∞—Ü—ñ—è –∫–æ–≤–∞—Ä–∏–∞—Ü—ñ—ó
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="–ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤–∏—Ä–æ–¥–∂–µ–Ω–Ω—è –º–∞—Ç—Ä–∏—Ü—ñ –∫–æ–≤–∞—Ä—ñ–∞—Ü—ñ–π. –ß–∏–º –º–µ–Ω—à–µ ‚Äî —Ç–∏–º —Ç–æ—á–Ω—ñ—à–µ. –°—Ç–∞–Ω–¥–∞—Ä—Ç: 1e-6.">‚ÑπÔ∏è</span>
      </label>
      <input type="number" step="any" class="form-control" id="reg_cov" name="reg_cov" value="1e-6">
    </div>

    <div class="mb-3">
      <label for="random_state" class="form-label">
        Random State (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="–§—ñ–∫—Å–æ–≤–∞–Ω–µ —á–∏—Å–ª–æ –¥–ª—è –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω–æ—Å—Ç—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: 42 –∞–±–æ –∑–∞–ª–∏—à–∏—Ç–∏ –ø—É—Å—Ç–∏–º.">‚ÑπÔ∏è</span>
      </label>
      <input type="number" class="form-control" id="random_state" name="random_state" placeholder="–ù–∞–ø—Ä., 42">
    </div>

    <div class="mb-3">
      <label for="init_params" class="form-label">
        –ú–µ—Ç–æ–¥ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="kmeans ‚Äî —Å—Ç–∞–±—ñ–ª—å–Ω—ñ—à–µ —ñ –∫—Ä–∞—â–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç; random ‚Äî —à–≤–∏–¥—à–µ, –∞–ª–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ –Ω–∞–±–∞–≥–∞—Ç–æ –≥—ñ—Ä—à–µ.">‚ÑπÔ∏è</span>
      </label>
      <select class="form-select" id="init_params" name="init_params">
        <option value="kmeans" selected>kmeans</option>
        <option value="random">random</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="covariance_type" class="form-label">
        –¢–∏–ø –∫–æ–≤–∞—Ä—ñ–∞—Ü—ñ—ó
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="–¢–∏–ø –∫–æ–≤–∞—Ä–∏–∞—Ü—ñ–π–Ω–æ—ó –º–∞—Ç—Ä–∏—Ü—ñ: full ‚Äî –ø–æ–≤–Ω–∞, diag ‚Äî –¥—ñ–∞–≥–æ–Ω–∞–ª—å–Ω–∞, tied ‚Äî –∑–∞–≥–∞–ª—å–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤.">‚ÑπÔ∏è</span>
      </label>
      <select class="form-select" id="covariance_type" name="covariance_type">
        <option value="full" selected>full</option>
        <option value="tied">tied</option>
        <option value="diag">diag</option>
        <option value="spherical">spherical</option>
      </select>
    </div>

    <div class="mb-3">
      <label for="gmm_impl" class="form-label">–í–∏–±—ñ—Ä —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó GMM</label>
      <select class="form-select" id="gmm_impl" name="gmm_impl">
        <option value="my-gmm">my-gmm</option>
        <option value="sklearn-gmm">sklearn-gmm</option>
      </select>
    </div>

    <!-- üß† –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–ª—è –¥–æ–Ω–∞–≤—á–∞–Ω–Ω—è -->
    <div class="mb-3">
      <label for="means_init" class="form-label">
        Means Init (JSON-–º–∞—Å–∏–≤, –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="–ó–∞–¥–∞—Ç–∏ –ø–æ—á–∞—Ç–∫–æ–≤—ñ —Å–µ—Ä–µ–¥–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—Ä—É—á–Ω—É. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: [[0.1, 0.2], [0.3, 0.4]]">‚ÑπÔ∏è</span>
      </label>
      <textarea class="form-control" id="means_init" name="means_init" rows="2"
                placeholder="[[0.1, 0.2], [0.3, 0.4]]"></textarea>
    </div>

    <div class="mb-3">
      <label for="precisions_init" class="form-label">
        Precisions Init (JSON-–º–∞—Å–∏–≤, –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="–ö–æ–≤–∞—Ä–∏–∞—Ü—ñ–π–Ω—ñ –º–∞—Ç—Ä–∏—Ü—ñ –≤—Ä—É—á–Ω—É. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: [[[1, 0], [0, 1]], [[1, 0], [0, 1]]]">‚ÑπÔ∏è</span>
      </label>
      <textarea class="form-control" id="precisions_init" name="precisions_init" rows="2"
                placeholder="[[[1, 0], [0, 1]], [[1, 0], [0, 1]]]"></textarea>
    </div>

    <div class="mb-3">
      <label for="weights_init" class="form-label">
        Weights Init (JSON-–º–∞—Å–∏–≤, –æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
        <span tabindex="0" class="text-info" data-bs-toggle="popover" data-bs-trigger="hover focus"
              data-bs-content="–í–∞–≥–∏ –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –∫–ª–∞—Å—Ç–µ—Ä—ñ–≤. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: [0.5, 0.5] ‚Äî –¥–≤–∞ –∫–ª–∞—Å—Ç–µ—Ä–∏ –∑ —Ä—ñ–≤–Ω–æ—é –≤–∞–≥–æ—é.">‚ÑπÔ∏è</span>
      </label>
      <textarea class="form-control" id="weights_init" name="weights_init" rows="1"
                placeholder="[0.5, 0.5]"></textarea>
    </div>

        <!-- üîÑ –í–∞–ª—ñ–¥/—Ç—Ä–µ–π–Ω/—Ç–µ—Å—Ç —Ä–æ–∑–ø–æ–¥—ñ–ª -->
        <div class="mb-3">
          <label class="form-label">–†–æ–∑–ø–æ–¥—ñ–ª –¥–∞–Ω–∏—Ö</label>
          <div class="input-group">
            <span class="input-group-text">–¢—Ä–µ–Ω—É–≤–∞–ª—å–Ω—ñ %</span>
            <input type="number" class="form-control" name="train_pct" value="70" min="0" max="100">
            <span class="input-group-text">–í–∞–ª—ñ–¥–∞—Ü—ñ—è %</span>
            <input type="number" class="form-control" name="val_pct" value="15" min="0" max="100">
            <span class="input-group-text">–¢–µ—Å—Ç %</span>
            <input type="number" class="form-control" name="test_pct" value="15" min="0" max="100">
          </div>
        </div>

  </form>
</div>

    <div class="mb-3">
      <label for="file" class="form-label">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ CSV-—Ñ–∞–π–ª (–Ω–µ–æ–±–æ–≤‚Äô—è–∑–∫–æ–≤–æ)</label>
      <input class="form-control" type="file" id="file" name="file" accept=".csv">
    </div>

    <input type="hidden" name="selected_file" id="selected_file">
    <button type="submit" class="btn btn-success">üîÅ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ GMM</button>
  </form>

  <div id="loading" style="display: none;" class="mt-3 alert alert-info">
    üîÑ –ê–Ω–∞–ª—ñ–∑ –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è... –ó–∞—á–µ–∫–∞–π—Ç–µ, –±—É–¥—å –ª–∞—Å–∫–∞.
  </div>
</div>



<!-- üìÅ –†–æ–±–æ—Ç–∞ –∑ –Ω–∞—è–≤–Ω–∏–º–∏ –º–æ–¥–µ–ª—è–º–∏ -->
<div id="existing-gmm-section" class="container my-4" style="display: none;">
  <h4>üì¶ –Ü—Å–Ω—É—é—á—ñ –º–æ–¥–µ–ª—ñ</h4>

  {% if models %}
  <table class="table table-striped">
    <thead>
      <tr>
        <th>–ù–∞–∑–≤–∞ –º–æ–¥–µ–ª—ñ</th>
        <th>–î–∞—Ç–∞</th>
        <th>–î—ñ—ó</th>
      </tr>
    </thead>
    <tbody>
      {% for model in models %}
      <tr>
        <td>{{ model.name }}</td>
        <td>{{ model.mtime }}</td>
        <td>
          <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –¥—ñ–π –∑ –º–æ–¥–µ–ª–ª—é , –±–µ–∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Ñ–ª–∞—Å–∫—É-->
          <button class="btn btn-primary btn-sm" disabled>üìà –ó—Ä–æ–±–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑</button>
          <button class="btn btn-warning btn-sm" disabled>üîÅ –î–æ–Ω–∞–≤—á–∞–Ω–Ω—è</button>
          <form method="POST" action="/download_gmm_model" style="display: inline;">
            <input type="hidden" name="model_path" value="{{ model.path }}">
            <button type="submit" class="btn btn-secondary btn-sm">‚¨Ü –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–æ–¥–µ–ª—å</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
  <div class="alert alert-info">–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –º–æ–¥–µ–ª–µ–π —É <code>/results</code>.</div>
  {% endif %}

  <div class="mb-3 mt-4">
    <label class="form-label">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–≤–æ—é –º–æ–¥–µ–ª—å (.json)</label>
    <input type="file" class="form-control" accept=".json">
  </div>
</div>


<div class="container my-4">
  <h4>üìÇ –û–±–µ—Ä—ñ—Ç—å CSV-—Ñ–∞–π–ª —ñ–∑ <code>uploads</code>:</h4>

  <div class="table-responsive">
    <table class="table table-striped">
      <thead>
        <tr>
          <th>–§–∞–π–ª</th>
          <th>–î–∞—Ç–∞</th>
          <th>–†–æ–∑–º—ñ—Ä</th>
          <th>–î—ñ—è</th>
        </tr>
      </thead>
      <tbody>
        {% for file in files[:10] %}
        <tr>
          <td>{{ file.name }}</td>
          <td>{{ file.mtime }}</td>
          <td>{{ file.size }}</td>
          <td>
            <button type="button" class="btn btn-outline-primary btn-sm" onclick="selectFile('{{ file.name }}')">–í–∏–±—Ä–∞—Ç–∏</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="d-flex justify-content-end mb-3">
    <a href="{{ url_for('results') }}" class="btn btn-outline-secondary">üìä –ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</a>
  </div>
</div>

<!-- JS –ª–æ–≥—ñ–∫–∞ -->

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    popoverTriggerList.forEach(function (el) {
      new bootstrap.Popover(el);
    });
  });

  function toggleGMMMode() {
    const mode = document.getElementById("gmm-mode").value;
    document.getElementById("new-gmm-section").style.display = (mode === "new") ? "block" : "none";
    document.getElementById("existing-gmm-section").style.display = (mode === "existing") ? "block" : "none";
  }

  function selectFile(filename) {
    document.getElementById('selected_file').value = filename;
    alert("–§–∞–π–ª " + filename + " –≤–∏–±—Ä–∞–Ω–æ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É");
  }

  document.getElementById('gmm-form').addEventListener('submit', function () {
    document.getElementById('loading').style.display = 'block';
  });
</script>

{% endblock %}
